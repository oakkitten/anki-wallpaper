[tox]
minversion = 3.24
skipsdist = true
skip_install = true
envlist =
    py38-anki2.1.49
    py39-anki2.1.51qt{5,6}
    py39-anki2.1.52qt{5,6}
    py39-ankipre

[testenv]
install_command =
    bash -xc ' \
        set -euxo pipefail; \
        if [[ "{envname}" =~ "ankipre" ]]; then \
            VER={env:PRE}; \
            REF=master; \
            AQT=aqt[qt6]; \
        else \
            VER=$(echo "{envname}" | perl -nle "m/anki([\d\.]+)/; print \$1"); \
            REF=$VER; \
            AQT=$(echo "{envname}" | perl -nle "m/qt(\d)/ and print qq(aqt[qt\$1]) or print q(aqt)"); \
        fi; \
        DIR=$(echo "$VER" | perl -nle "m/^2\.1\.4/ and print q(pip) or print q(python)"); \
        curl "https://raw.githubusercontent.com/ankitects/anki/$REF/$DIR/requirements.txt" \
            | sed -r "/pip|setuptools|pytest|black|mypy|types-/d" \
            | pip install -r /dev/stdin; \
        python -m pip install "anki==$VER" "$AQT==$VER"; \
        python -m pip install "$\{@:1\}"; \
    ' {packages}

commands =
    env HOME={envtmpdir}/home xvfb-run python -m pytest {posargs}

setenv =
    DISABLE_QT5_COMPAT=1
    PRE=2.1.53rc1

allowlist_externals =
    bash
    env
    xvfb-run

deps =
    pytest==7.1.1
    pytest-forked==1.4.0
    pytest-anki @ git+https://github.com/oakkitten/pytest-anki.git@a0d27aa5
